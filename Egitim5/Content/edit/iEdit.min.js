$(document).ready(function(){function i(i){var t=i.offset().top,e=i.offset().left,d={top:t-$(window).scrollTop(),left:e-$(window).scrollLeft()};return d}var t='<div class="iEdit-img-edit"><canvas class="iEdit-img-edit-can"></canvas><canvas class="iEdit-img-edit-process-can"></canvas><div class="iEdit-img-edit-select"><div class="iEdit-img-edit-select-resize"></div></div><div class="iEdit-img-edit-act iEdit-img-edit-save"> Done </div><div class="iEdit-img-edit-act iEdit-img-edit-cancel"> Cancel </div></div>';$("body").append(t),window.iEdit={can:$(".iEdit-img-edit-can")[0],processCan:$(".iEdit-img-edit-process-can")[0],selectionBox:$(".iEdit-img-edit-select"),container:$(".iEdit-img-edit"),saveBtn:$(".iEdit-img-edit-save"),cancelBtn:$(".iEdit-img-edit-cancel"),drag:!1,resize:!1,square:!0,status:!1,grcx:null,grcy:null,callback:null,imageType:null,imageQuality:1,open:function(i,t,e,d,c){if(i.constructor!==File||!i.type.match("image.*"))return!1;this.drag=!1,this.resize=!1,this.square=t===!0?!0:!1,this.imageQuality=Number(c)>0&&Number(c)<=1?Number(c):1,"jpeg"==d||"png"==d||"gif"==d||"bmp"==d?this.imageType=d:this.imageType="jpeg",this.grcx=!1,this.grcy=!1;var n={};this.callback=e&&"[object Function]"===n.toString.call(e)?e:!1,this.status=!0;var a=this.can.getContext("2d");iEdit.container.css("display","block").stop().animate({opacity:"1"});var o=new Image,s=this;return $(o).on("load",function(){o.width>o.height?(s.can.width=o.width,s.can.height=o.height,s.can.style.width=$(window).width()/2*1+"px",s.can.style.height=o.height*($(window).width()/2*1/o.width)+"px",a.fillStyle="#fff",a.fillRect(0,0,s.can.width,s.can.height),a.drawImage(o,0,0,s.can.width,s.can.height),iEdit.selectionBox.height($(s.can).height()-20),iEdit.selectionBox.width($(s.can).height()-20),iEdit.selectionBox.css({left:$(window).width()/2-$(s.can).height()/2+10+"px",top:$(window).height()/2-$(s.can).height()/2-15+"px"})):o.width<o.height?(s.can.width=o.width,s.can.height=o.height,s.can.style.width=o.width*($(window).height()/3*2/o.height)+"px",s.can.style.height=$(window).height()/3*2+"px",a.fillStyle="#fff",a.fillRect(0,0,s.can.width,s.can.height),a.drawImage(o,0,0,s.can.width,s.can.height),iEdit.selectionBox.height($(s.can).width()-20),iEdit.selectionBox.width($(s.can).width()-20),iEdit.selectionBox.css({left:$(window).width()/2-$(s.can).width()/2+10+"px",top:$(window).height()/2-$(s.can).width()/2-15+"px"})):(s.can.width=o.width,s.can.height=o.height,s.can.style.width=$(window).height()/4.8*3.3+"px",s.can.style.height=$(window).height()/4.8*3.3+"px",a.fillStyle="#fff",a.fillRect(0,0,s.can.width,s.can.height),a.drawImage(o,0,0,s.can.width,s.can.height),iEdit.selectionBox.height($(s.can).width()-20),iEdit.selectionBox.width($(s.can).width()-20),iEdit.selectionBox.css({left:$(window).width()/2-$(s.can).width()/2+10+"px",top:$(window).height()/2-$(s.can).width()/2-15+"px"}))}),o.src=URL.createObjectURL(i),!0},close:function(){this.drag=!1,this.resize=!1,this.square=!0,this.status=!1,this.grcx=void 0,this.grcy=void 0,this.callback=void 0,this.can.height=0,this.can.width=0,this.processCan.height=0,this.processCan.width=0;var i=this.processCan.getContext("2d"),t=this.can.getContext("2d");t.clearRect(0,0,0,0),i.clearRect(0,0,0,0),iEdit.selectionBox.css({height:"0px",width:"0px"}),iEdit.container.stop().animate({opacity:"0"},300),setTimeout(function(){iEdit.container.css({display:"none"})},300)}},$(document).on("mouseup",function(){iEdit.drag=!1,iEdit.resize=!1,iEdit.grcx=!1,iEdit.grcy=!1}),iEdit.selectionBox.on("mousedown",function(t){var e=$(this),d=t.clientX-i(e).left,c=t.clientY-i(e).top;iEdit.grcx=!1,iEdit.grcy=!1,iEdit.selectionBox.width()-d<=28&&iEdit.selectionBox.height()-c<=28?(iEdit.drag=!1,iEdit.resize=!0):(iEdit.drag=!0,iEdit.resize=!1)}),$(document).on("mousemove",function(t){var e=t.clientX-i(iEdit.selectionBox).left,d=t.clientY-i(iEdit.selectionBox).top;if(iEdit.drag===!0&&iEdit.status){iEdit.grcx===!1&&(iEdit.grcx=e),iEdit.grcy===!1&&(iEdit.grcy=d);var c=t.clientX-iEdit.grcx,n=t.clientY-iEdit.grcy;c+iEdit.selectionBox.width()>=$(iEdit.can).width()+i($(iEdit.can)).left||c<=i($(iEdit.can)).left?c<=i($(iEdit.can)).left?iEdit.selectionBox.css({left:i($(iEdit.can)).left+"px"}):iEdit.selectionBox.css({left:i($(iEdit.can)).left+$(iEdit.can).width()-iEdit.selectionBox.width()+"px"}):iEdit.selectionBox.css({left:c+"px"}),n+iEdit.selectionBox.height()>=$(iEdit.can).height()+i($(iEdit.can)).top||n<=i($(iEdit.can)).top?n<=i($(iEdit.can)).top?iEdit.selectionBox.css({top:i($(iEdit.can)).top+"px"}):iEdit.selectionBox.css({top:i($(iEdit.can)).top+$(iEdit.can).height()-iEdit.selectionBox.height()+"px"}):iEdit.selectionBox.css({top:n+"px"})}else if(iEdit.resize===!0&&iEdit.status){var a=e,o=d;iEdit.square?(a>=o?(o=a,100>a&&(a=100,o=100)):(a=o,100>o&&(a=100,o=100)),a+i(iEdit.selectionBox).left>=$(iEdit.can).width()+i($(iEdit.can)).left?(a=i($(iEdit.can)).left+$(iEdit.can).width()-i(iEdit.selectionBox).left,i(iEdit.selectionBox).top+a>$(iEdit.can).height()+i($(iEdit.can)).top&&(a=i($(iEdit.can)).top+$(iEdit.can).height()-i(iEdit.selectionBox).top),o=a):o+i(iEdit.selectionBox).top>=$(iEdit.can).height()+i($(iEdit.can)).top&&(o=i($(iEdit.can)).top+$(iEdit.can).height()-i(iEdit.selectionBox).top,i(iEdit.selectionBox).left+o>$(iEdit.can).width()+i($(iEdit.can)).left&&(o=i($(iEdit.can)).left+$(iEdit.can).width()-i(iEdit.selectionBox).left),a=o)):(100>=a&&(a=100),100>=o&&(o=100),t.clientX>=$(iEdit.can).width()+i($(iEdit.can)).left&&(a=i($(iEdit.can)).left+$(iEdit.can).width()-i(iEdit.selectionBox).left),t.clientY>=$(iEdit.can).height()+i($(iEdit.can)).top&&(o=i($(iEdit.can)).top+$(iEdit.can).height()-i(iEdit.selectionBox).top)),iEdit.selectionBox.css({width:a+"px",height:o+"px"})}}),iEdit.saveBtn.on("click",function(){if(!iEdit.callback)return void iEdit.close();var t=iEdit.can.width/$(iEdit.can).width(),e=iEdit.selectionBox.height()*t,d=iEdit.selectionBox.width()*t,c=(i(iEdit.selectionBox).left-i($(iEdit.can)).left)*t,n=(i(iEdit.selectionBox).top-i($(iEdit.can)).top)*t;iEdit.processCan.height=e,iEdit.processCan.width=d;var a=iEdit.processCan.getContext("2d");a.drawImage(iEdit.can,c,n,d,e,0,0,d,e),iEdit.callback(iEdit.processCan.toDataURL("image/"+iEdit.imageType,iEdit.imageQuality)),iEdit.close()}),iEdit.cancelBtn.on("click",function(){iEdit.close()}),$(window).on("resize",function(){iEdit.status&&iEdit.selectionBox.css({left:$(window).width()/2-$(iEdit.can).height()/2+10+"px",top:$(window).height()/2-$(iEdit.can).height()/2+10+"px"})})});